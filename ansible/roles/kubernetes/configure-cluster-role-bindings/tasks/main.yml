---

- name: Create ClusterRoleBindings for service accounts
  k8s:
    kubeconfig: "{{ kubernetes.kubeconfig }}"
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: "{{ item.key }}-binding"
        labels:
          infra.haondt.dev/managed-by: ansible
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: "{{ item.value.roles[0] }}"
      subjects:
        - kind: ServiceAccount
          name: "{{ item.key }}"
          namespace: "{{ item.value.namespace | default(kubernetes.default_namespace) }}"
  loop: "{{ kubernetes.service_accounts | dict2items }}"

